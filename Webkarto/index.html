<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name = 'Author' content="Vincze Csilla">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" >
    <title> Meteorológiai Adattár </title>  
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>    
    <!-- Load jQuery and PapaParse to read data from a CSV file --> 
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <!--JSZIP-->
    <script src="Webkarto/jszip.js"></script>
    <!--ploty-->
    <script src="https://cdn.plot.ly/plotly-2.18.0.min.js"></script>
    <!--Webstyle-->
    <link rel="stylesheet" href="Webkarto/style.css">
    <!-- Load icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--favicon-->
    <link href="Webkarto/favicon.ico" rel="icon" type="image/x-icon" />
</head>  
<body>
    <div class="menu">
     <div class="menu-flex"> 
        <div class = "title">
            <i class="fa fa-cloud" style="font-size: 2em"></i>
            <a href="https://odp.met.hu" title="ODP">Meteorológiai Adattár</a>           
       </div>
        <!-- The form -->
        <form class="btn_keres">
            <input type="text" placeholder="Name to Search.." name="search" id="hely" />
            <button type="button" id="Btn" onclick="kereses()"><i class="fa fa-search"></i></button>
            <button type="button" id="Btn2" onclick="clearmap()"><i class="fa fa-times"></i></button>
        </form>
        <!--Form 2 by latlon -->
       <!-- <form class="btn_keres2"> -->
       <!-- <input type="number" placeholder="Longitude.." name="search" id="lon"/> -->
       <!-- <input type="number" placeholder="Latitude.." name="search" id="lat"/> -->
       <!-- <button type="button" id="Btn" onclick="kereses()"><i class="fa fa-search"></i></button> -->
       <!-- <button type="button" id="Btn2" onclick="clearmap()"><i class="fa fa-times"></i></button> -->
        </form>
     </div> 
    </div>
    <div class="content_p"> 
        <!-- Térkép megjelenítése -->                    
        <div id="map">
            <script>
                var  map = L.map('map').setView([47.475,19.062], 7),
                     varosok=L.layerGroup().addTo(map),
                     stations=L.layerGroup().addTo(map),
                     pontok=[],
                     dolgok=L.layerGroup().addTo(map);

                var stationsGeoJSON = {
                        "type": "FeatureCollection",
                        "features": [ ]};

                var stationIcon = L.icon ({
                        iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",                    
                        iconSize:     [28, 45],
                        iconAnchor: [14, 44],
                        popupAnchor: [0, 0],});     
     
                //map              
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            minZoom: 5,
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);
                        map.attributionControl.setPrefix(
                        'View <a href="https://github.com/HandsOnDataViz/leaflet-map-csv" target="_blank">map-csv code on GitHub</a>'
                                    );  

                //met.hu állomások rétegcsoport
                //"https://odp.met.hu/climate/observations_hungary/10_minutes/station_meta_auto.csv"   
                $.get('./Webkarto/data.csv', function(csv) {
                var data = Papa.parse(csv, {header: true, download: false, encoding: "UTF-8", delimiter: ";", 
                            skipEmptyLines: true, dynamicTyping: true, 
                            transformHeader:function(h) {
                            return h.trim()},
                            complete: function(results) {
                                results.data.forEach((row) => {
                                feature = {"type": "Feature",
                                            "geometry": {
                                            "type": "Point",
                                            "coordinates": [row.Longitude, row.Latitude] },
                                            "properties": {
                                            "Location": row.StationName }}
                                stations_layer = L.geoJSON(feature, {
                                                pointToLayer: function (feature, latlng) {
                                                            return L.marker(latlng, {icon: stationIcon});
                                                    }}).bindTooltip(row.StationNumber + ", "+ row.RegioName + "," + row.StationName).addTo(stations)
                                stationsGeoJSON.features.push(feature)
                                 })    
                               }
                            });
                        });       
                
            // --------------FUNKCIÓK: ------------------------   
                function kereses() {                   
                // megkeressük a 'hely' id-jű elemet és a beleírt értéket eltároljuk
                var h=document.getElementById("hely").value;
                var url="https://nominatim.openstreetmap.org/search/place?format=geojson&country=Hungary&city="+h;
                    fetch(url).then(r=>r.json()).then(data=>{
                        var eredmeny=L.geoJson(data).addTo(varosok).bindTooltip(tooltipszöveg);
                            eredmeny.on('click',e=>{
                                    let hely=e.latlng;
                                    pontok[0] = e.latlng;
                                    let dmin=21000000; // ennél semmi sem lehet messzebb a földön
                                    let pont;
                                    stations.eachLayer(l=>{
                                        let d=hely.distanceTo(l.getLayers()[0].getLatLng());
                                        if (d<dmin) {
                                            dmin=d;
                                            pont=l.getLayers()[0];
                                        }                               
                                    })
                                    pontok[1]= pont.getLatLng();
                                    console.log(pontok);
                                    //pont.bindPopup('Ez a legközelebbi hely. Távolság: '+(dmin/1000).toFixed(2)+'km').openPopup();         
                                    //vonal rajzolasa a 2 koze
                                    L.polyline(pontok).addTo(dolgok)
                                        .bindPopup("Távolság: "+(dmin/1000).toFixed(2)+" km")
                                        .openPopup();
                                                });
                        map.fitBounds(eredmeny.getBounds(), {
                             padding: [50, 50]
                                });                                   
                                            });        
                //clear text        
                document.getElementById("hely").value="";
                };
                
                //x-el kitörlöm a layereket
                function clearmap() {                   
                    varosok.clearLayers();
                    dolgok.clearLayers();
                };

                //Press Enter hely kereses    
                var input = document.getElementById("hely");
                input.addEventListener("keypress", function(event) {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        document.getElementById("Btn").click();
                        event.currentTarget.value = "";
                    }
                });

                //tooltip a geokódoláshoz        
                function tooltipszöveg (layer){
                var prop = layer.feature.properties;
                return (prop.icon?('<img src="'+prop.icon+'">'):'')
                        +layer.feature.properties.display_name;
                }; 
               
                //------------------search by click -------------------------------------            
                var n=0;
                map.on('click', function(e) {
                     //marker
                        n++;
                        let helyid = e.latlng;
                        L.marker(e.latlng).addTo(dolgok)
                             .bindPopup(n+'.pont')
                             .openPopup();
                        pontok[0]=e.latlng;
                        let dmin=21000000; // ennél semmi sem lehet messzebb a földön
                        let pont;
                    stations.eachLayer(l=>{
                        let d=helyid.distanceTo(l.getLayers()[0].getLatLng());
                                        if (d<dmin) {
                                            dmin=d;
                                            pont=l.getLayers()[0];
                                        }
                                    })
                    pontok[1]=pont.getLatLng();
                    console.log(pontok);                				
                    L.polyline(pontok).addTo(dolgok)
                             .bindPopup("Távolság: "+(dmin/1000).toFixed(2)+" km")
                             .openPopup();				
                         });			        

                // find me : map.locate({setView: true, maxZoom: 16});
                //https://leafletjs.com/examples/mobile/                                                             
            </script>      
        </div>
        <!--Grafikon megjelenítése-->
        <div class = "graph">
        <p> Meteorológiai állomás grafikus megjelenítése: </p>
            <form class="btn_keres">
                <input type="text" placeholder="13704" name="search1" id="code" /> <!--StationNumber...-->
                <button type="button" id="Btn1" onclick="statkeres()"><i class="fa fa-search"></i></button>
            </form>
            <div id="myPlot">
               <script>
                    // metdata fom zip file
                    var zip = new JSZip();
                    var datum=[];
                    var akthom=[];
                        fetch('./Webkarto/HABP_10M_13704_now.zip')
                            .then(r=>r.arrayBuffer())
                                .then(d=>zip.loadAsync(d))
                                    .then(z=>z.file(/./)[0].async("text"))
                                        .then(d=>{
                                            let sorok=d.split('\n');
                                            for (let i=7;i<sorok.length;i++) {
                                                let adatok=sorok[i].split(';');
                                                for (let j in adatok) {
                                                    adatok[j]=adatok[j].trim();
                                                }
                                                datum.push(adatok[1]);
                                                akthom.push(Number(adatok[4]));
                                            }
                                        });
                    console.log(datum);
                    const pattern= /\d{4}\\d{2}\\d{2}\\d{2})\\d{2}/;                    
                    var ido=new Date(datum.split(pattern));
                    console.log(ido);

                    // Define Data
                    var data = [{
                    x: datum,
                    y: Number(akthom),
                    mode:"lines",
                    type:"scatter"
                    }];
                    
                    console.log(data);

                    // Define Layout
                    var layout = {
                    xaxis: { title: "Time 10min"},
                    yaxis: { title: "Temperature in °C"},
                    title: "Meteogram"
                    };

                    Plotly.newPlot("myPlot", data, layout);
               </script> 
            </div>
        </div>
    </div>   
    <div class="footer">
            <hr>
    <div class="break"></div>
        <div class="flex-item">
            <div class="block1">
                <p>© 2022 Copyright: </p>
                <a href = "https://github.com/vcsicsi/">  Vincze Csilla </a>
            </div> 
    <div class="break"></div>
            <div class="block1">
                <p>© Maps:   </p>
                <a href="https://leafletjs.com/">  Leaflet </a>
            </div>   
    <div class="break"></div>
            <div class="block1">
                <p>© Data: </p>
                <a href="https://met.hu/">  Országos Meteorológiai Szolgálat </a>
            </div>       
        </div>      
    </div>   
</body>
</html>  